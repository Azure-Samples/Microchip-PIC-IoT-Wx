# Connecting the Microchip PIC-IoT Wx Development Board to Azure IoT Hub

## Introduction

[Azure IoT Hub](https://docs.microsoft.com/en-us/azure/iot-hub/about-iot-hub) is a managed service, hosted in the Cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub.

IoT Hub supports communications both from the device to the cloud and from the cloud to the device. IoT Hub supports multiple messaging patterns such as device-to-cloud telemetry, file upload from devices, and request-reply methods to control your devices from the cloud. IoT Hub monitoring helps you maintain the health of your solution by tracking events such as device creation, device failures, and device connections.

IoT Hub's capabilities help you build scalable, full-featured IoT solutions such as managing industrial equipment used in manufacturing, tracking valuable assets in healthcare, and monitoring office building usage.

## Procedure

### **Enroll Device into DPS (Device Provisioning Service)**

1. Set up certificates for the verification process:

    - Go to generated cert location in the previous step at `\[your_path]\.microchip-iot`

    - Copy all `*.crt` files and rename them each to `*.pem`

2. In the [Microsoft Azure Portal](https://portal.azure.com/#home), upload the root CA cert `root-ca.pem` in DPS and do proof-of-possession for X.509 CA certificates with your Device Provisioning Service

- Register the public part of an X.509 certificate and get a verification code

    Follow the `Register the public part of an X.509 certificate and get a verification code` section in [How to Verify Certificates](https://docs.microsoft.com/azure/iot-dps/how-to-verify-certificates)

    The verification code is generated by encrypting the public key portion of your X.509 certification. It will be used to validate the uploaded certificate ownership. So make sure to copy the generated verification code to clipboard for use in an upcoming step.

- Digitally sign the verification code to create a verification certificate

    Now that you've registered your root CA with Azure IoT Hub, you'll need to prove that you actually own it by:

> 1. Generating the Certificate Signing Request (CSR) using the
    verification code.
> 2. Generating a verification certificate using CSR above

### **Demonstrate Proof of Possession**

Upload your verification certificate to DPS for [Proof of Possession](https://tools.ietf.org/html/rfc5280#section-3.1) with the following steps:

1. Open a Git Bash window (Start menu &gt; type “Git Bash”)

    <img src=".//media/image15.png" style="width:3.21739in;height:0.94745in" alt="A picture containing ball, clock Description automatically generated" />

2. Change the directory to your certificates folder (which was generated by the IoT Provisioning Tool):

    ```bash
    cd drive\[your path\.microchip-iot

    Example: cd /C/Users/john5/Azure/.microchip-iot
    ```

3. Generate a certification signing request (CSR) by entering the below command. A CSR is generated by encrypting these two key inputs:

    - The `root-ca.key` generated in previous step by Microchip IoT Provisioning tool. This will be used in the openssl command line below.
    - The `Verification Code` generated from DPS in previous step. You will be asked to provide this during the process of creating the CSR.

    **Note**: Once you enter to command below, you will then be asked to enter information that will be used to will be incorporated into your certificate request. Enter verification code (generated from Azure portal) when prompt for CommonName. For the rest, you can enter anything you want.

    ```bash
    openssl req -new -key root-ca.key -out azure_root_ca_verification.csr
    ```

    As a result, you should see the file `azure_root_ca_verification.csr` appear in the \\.microchip-iot folder: 

    <img src=".//media/image16.png" style="width:6.12286in;height:3.47003in" alt="A screenshot of a cell phone Description automatically generated" />

4. Generate a verification certificate by executing the following command:

    ```bash
    openssl x509 -req -in azure_root_ca_verification.csr -CA root-ca.crt -CAkey root-ca.key -CAcreateserial -out azure_signer_verification.cer -days 365 -sha256
    ```

    As a result, you should see the file `azure_signer_verification.cer` appear in the \\.microchip-iot folder:

    <img src=".//media/image17.png" style="width:5.14375in;height:0.784in" alt="A screenshot of a computer screen Description automatically generated" />

### **Upload the Signed Verification Certificate to DPS**

Follow the `Upload the signed verification certificate` section in
[How to Verify Certificates](https://docs.microsoft.com/azure/iot-dps/how-to-verify-certificates).  As a result, the status of your uploaded certification should be “Verified” as shown below (make sure to refresh the page to see the updated change in status). 

<img src=".//media/image18.png" style="width:5.256in;height:1.40665in" alt="A screenshot of a social media post Description automatically generated" />

### **Add a New Enrollment Group using the Signer Certificate**

1. In the Azure portal, navigate to your DPS &gt; `Manage enrollments` &gt;
Select `Enrollment Groups` tab:

    <img src=".//media/image19.png" style="width:4.86246in;height:3.09722in" alt="A screenshot of a cell phone Description automatically generated" />

2. Add enrollment group &gt; Enter `Group name` &gt; Choose Certificate as `Attestation Type` &gt; Choose `False` for IoT Edge Device &gt; Choose `Intermediate Certificate` as Certificate Type &gt; Upload
`\[path]\.microchip-iot\signer-ca.pem` to Primary Certificate &gt; select `Evenly weighted distribution` for how you want to assign devices to hub &gt; select your IoT Hub that this new enrollment group can assign to &gt; leave the rest as their existing defaults &gt; hit `Save`

    <img src=".//media/image20.png" style="width:3.0in;height:5.0in" alt="A screenshot of a cell phone Description automatically generated" />
    
    Once this has been done, your enrollment group name should show up in the Enrollment Groups tab

### **Program the Plug and Play Demo**

1. Clone/download the MPLAB X demo project
    by issuing the following commands in a `Command Prompt` or `PowerShell`
    window:

    ```bash
    git clone https://github.com/Azure-Samples/Microchip-PIC-IoT-Wx.git
    cd Microchip-PIC-IoT-Wx
    git submodule update --init
    ```

2. Launch the MPLAB X IDE and navigate to the main toolbar's `File` > `Open Project` operation to load the demo project folder (\*.X) located
    at:

    ```bash
    [path]\Microchip-PIC-IoT-Wx\AzureIotPnpDps
    ```

    <img src=".//media/image40.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

   If the `load error` message in red appears, click on the `Resolve DFP for configuration: default` link: 

    <img src=".//media/image21.png" style="width:6.5in;height:1.00833in" alt="A screenshot of a cell phone Description automatically generated" />

3. Set the `AzureIotPnpDps` project as the main (currently focused/active) project by right-clicking on it and selecting `Set as Main Project`

    <img src=".//media/image41.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

4. Modify `AzureIotPnPDps/Header Files/platform/config/conf_winc.h` with your
    wireless router’s SSID and password (keeping the surrounding quotation marks for each); for example

    ```c
    #define CFG_MAIN_WLAN_SSID "MY_WIFI_AP_SSID"
    #define CFG_MAIN_WLAN_PSK  "MY_WIFI_AP_PSWD"
    ```

    > [!TIP]  
    > You may also configure the WiFi SSID and password using the `wifi` command via the Command Line Interface (CLI); e.g.
    ```bash
    wifi <MY_WIFI_AP_SSID>,<MY_WIFI_AP_PSWD>,2
    ```

5. Verify the project properties are set correctly before building the
   project:

    - Connect the board to PC, then make sure `CURIOSITY` device shows up as a disk drive in a File Explorer window

    - Right-click the project `AzureIotPnPDps` &gt; select `Properties` &gt; Verify
    that all Configuration settings are at least the minimum versions as
    shown in the below screenshot (and that your PIC-IoT board is
    selected as the Connected Hardware Tool). If any changes were made in the project properties window,
    make sure to hit the `Apply` button before hitting `OK`.

    <img src=".//media/image26.png" style="width:5.88652in;height:2.68981in" alt="A screenshot of a social media post Description automatically generated" />

6. Build the project and set up a Command Line Interface (CLI) to the board:

    - Open a serial terminal (e.g. PuTTY, TeraTerm, etc.) and connect to the COM port corresponding to your board at 9600 baud (e.g. open PuTTY Configuration window &gt; choose `session` &gt; choose `Serial` &gt; Enter the right `COMx` port). You can find the COM info by opening your PC’s Device Manager &gt; expand `Ports(COM & LPT)` &gt; take note of `Curiosity Virtual COM Port`. 

        <img src=".//media/image27.png" style="width:3in;height:3in" alt="A screenshot of a cell phone Description automatically generated" />

    - Right-click the `AzureIotPnPDps` project and select `Make and Program Device`.  This operation will automatically clean and build the project before attempting to program the target device. After the `BUILD SUCCESSFUL` message appears in the Output window, the application HEX file will be programmed onto the PIC-IoT board. Once programming has finished, the board will automatically reset and start running its application code.

7. In the terminal emulator window, hit `[RETURN]` to get the list of available commands for the Command Line Interface (CLI).  The Command Line Interface allows you to send simple ASCII-string commands to set or get the user-configurable operating parameters of the application while it is running.  The CLI prompt is simply the `.` (period) character

    <img src=".//media/image44.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

8. Look up the ID Scope corresponding to your DPS in the Microsoft Azure Portal.  This value is displayed in a web browser when clicking on `Overview` on the DPS resource page (the DPS was created earlier using a web page on the Azure Portal).  The ID Scope is programmed/saved into the PIC-IoT board in the next step using a CLI command (allowing you to change the ID Scope for the board without having to reprogram the MCU's application firmware)

    <img src=".//media/image23.png" style="width:6.5.in;height:1.43506in" alt="A screenshot of a cell phone Description automatically generated" />

9. In the terminal emulator window, confirm that `local echo` is enabled in the terminal settings.  At the CLI prompt, type in the command `idscope <MY_ID_SCOPE>` to set the ID Scope (which gets saved in the ATECC608A secure element on the PIC-IoT board) and then hit `[RETURN]`.  To confirm it was set correctly, the ID Scope can be read out from the board by issuing the `idscope` command (i.e. without specifying an ID Scope value as the parameter on the command line)

    <img src=".//media/image46.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

10. At the CLI prompt, type in the command `reset` and hit `[ENTER]` to restart the application using the updated ID Scope to establish a connection to your DPS.

11.	Wait for the PIC-IoT board to connect to your DPS and stabilize (allow up to 2 minutes); eventually the Blue and Green LEDs should both stay constantly on (which signifies a successful & stable DPS connection).  If the Red LED comes on and stays lit, then something was incorrectly programmed (e.g. application firmware, Wi-Fi credentials, ID Scope).  If the Blue LED is not constantly on, then there is an issue with connecting to your wireless access point.

12. To enable the “full” debug messaging output to the terminal emulator window, execute the command `debug 4` on the Command Line Interface (CLI).  To disable the debug messages at any time, execute the command `debug 0` (debug levels range from 0 to 4).  The CLI is always active, even while debug messages are being continuously displayed on the terminal window.

13. Experiment with the CLI commands to control the LED’s from the terminal emulator window by issuing the led command (usage: "led [led],[state]")
[led] : {1 = blue, 2 = green, 3 = yellow, 4 = red}
[state] : {1 = on, 2 = off, 3 = start blinking, 4 = stop blinking}

    <img src=".//media/image75.png" style="width:8.in;height:6.18982in" alt="A screenshot of a cell phone Description automatically generated" />	

### **Verify the PIC-IoT Device Registration to Azure IoT Hub**

A successful PIC-IoT to Azure DPS connection can be verified two ways:

1) Correct device ID shows up in the DPS enrollment
2) Correct device ID shows up in the IoT Hub

Procedure:

1. In the [Azure Portal](https://portal.azure.com/#home), go to your DPS &gt; click `Manage enrollments` &gt; under Enrollment Group, click `your group name` &gt; click `Registration Records` &gt; device should show up with the IoT Hub info that it got assigned to

    <img src=".//media/image28.png" style="width:5.64758in;height:2.34954in" alt="A screenshot of a social media post Description automatically generated" />

2. In the [Azure Portal](https://portal.azure.com/#home), go to your IoT Hub &gt; click `IoT
    Devices` &gt; click `Refresh` &gt; device should show up with the
    Status “Enabled” and Authentication Type of “SelfSigned”

    <img src=".//media/image29.png" style="width:4.91723in;height:2.58102in" alt="A screenshot of a cell phone Description automatically generated" />

### **PIC-IoT Board Interaction with Azure IoT Explorer**

 Once the PIC-IoT connection to Azure IoT Hub has been verified, the device can be monitored & controlled using Microsoft's Azure IoT Explorer. The Azure IoT Explorer is a graphical tool for interacting with and testing your IoT device on Azure. Refer to [Install Azure IoT Explorer](https://docs.microsoft.com/azure/iot-pnp/howto-install-iot-explorer#install-azure-iot-explorer) for additional details.

1. Connect Azure IoT Explorer to IoT Hub by providing your IoT Hub’s connection string.  From the Azure Portal: click on `your IoT Hub` &gt; `Shared access polices` &gt; `iothubowner` &gt; connection string-primary key &gt; Copy to clipboard

    <img src=".//media/image30.png" style="width:2in;height:4in" alt="A screenshot of a cell phone Description automatically generated" />

2. Launch Azure IoT Explorer: Click on “Add connection” &gt; paste the
    Connection String &gt; Save

    <img src=".//media/image31.png" style="width:5.56482in;height:2.24436in" alt="A screenshot of a cell phone Description automatically generated" />

    <img src=".//media/image37.png" style="width:4.49781in;height:3.72222in" alt="A screenshot of a cell phone Description automatically generated" />

3. In the Azure IoT Explorer window, click on the `Home` link near the top of the window

4. On the left-hand side of the Azure IoT Explorer window, click on `IoT Plug and Play Settings`

    <img src=".//media/image48.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

5. Please make sure `Public repository` is in the list

    If `Public repository` is not listed, add it using the `Add` icon

    <img src=".//media/image49.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

6. Click on `Save`

    <img src=".//media/image50.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

7. On the left-hand side of the IoT Explorer window, click on `IoT hubs`

    <img src=".//media/image51.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

8. Verify that the name of your IoT hub is displayed, then click on `View devices in this hub`

    <img src=".//media/image52.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

9. Verify that your device ID is displayed (and status is enabled), then click on it

    <img src=".//media/image53.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />
  
10. On the left-hand side of the IoT Explorer window, click on `IoT Plug and Play components`

    <img src=".//media/image54.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />	

11.	Click on `Default component` near the bottom of the IoT Explorer window

    <img src=".//media/image55.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />
 
12.	Click on `Properties (read-only)` near the top of the IoT Explorer window

13.	Confirm that the `Enum` value of each LED matches the state observed on the PIC-IoT board (1 = On, 2 = Off, 3 = Blinking) and note the maximum temperature reading since device reset (maxTempSinceLastReboot)

    <img src=".//media/image57.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

14.	Click on `Properties (writable)` near the top of the IoT Explorer window

15. Click on the input field labeled `led_yellow` and select `Blink`

    <img src=".//media/image59.png" style="width:5.in;height:1.48982in" alt="A screenshot of a cell phone Description automatically generated" />

16. Click on `Update desired value`

    <img src=".//media/image60.png" style="width:5.in;height:1.48982in" alt="A screenshot of a cell phone Description automatically generated" />

17. Observe the notification that the request to write the property was accepted by your device, and that the Yellow LED on the PIC-IoT board is blinking/toggling/flashing

    <img src=".//media/image61.png" style="width:5.in;height:1.48982in" alt="A screenshot of a cell phone Description automatically generated" />

18. Click on `Commands` near the top of the IoT Explorer window

19. To set up the getMaxMinReport command, hover the mouse near the right corners of the since input field until the little triangle shows up and then click on it

20. When the calendar window pops up, select today’s date

    <img src=".//media/image64.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

21. Type in the current time

    <img src=".//media/image65.png" style="width:4.in;height:1.18982in" alt="A screenshot of a cell phone Description automatically generated" />

22. Click on `Send command`

    <img src=".//media/image66.png" style="width:4.in;height:1.78982in" alt="A screenshot of a cell phone Description automatically generated" />

23. Confirm that the command was successfully invoked and that both the max & min temperatures are reported in the message that appears in the pop-up window (once the message window disappears, it can be read again by clicking on `Notifications`)

    <img src=".//media/image67.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

24. Click on `Telemetry` near the top of the IoT Explorer window and then click on `Start`

25. Observe the telemetry data (for the temperature and light sensors) is updating every few seconds

    <img src=".//media/image69.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

26. Increase the ambient light shining on top of the board and observe that the value of the light sensor increases within a few seconds

    <img src=".//media/image70.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

27. On the PIC-IoT Wx development board, press and release user buttons SW0 and/or SW1 

    <img src=".//media/image71.png" style="width:5.in;height:1.18982in" alt="A screenshot of a cell phone Description automatically generated" />

28. Observe the button event message (telemetry) that is generated each time a user button has been pressed/released

    <img src=".//media/image72.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

29. Click on `Commands` near the top of the IoT Explorer window

30. Click on the input field for `delay` and type `PT10S`, then click `Send command`.  Confirm that the command was successfully invoked via a notification message, and then the board resets itself in approximately 10 seconds (the LEDs on the board will cycle and re-initialize)

    <img src=".//media/image74.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />
