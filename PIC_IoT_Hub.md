# Connecting the Microchip PIC-IoT Wx Development Board to Azure IoT Hub

NOTE: Should you encounter any issues/obstacles with the following procedure, check out the [FAQ section](./FAQ.md)

## Introduction

[Azure IoT Hub](https://docs.microsoft.com/en-us/azure/iot-hub/about-iot-hub) is a managed service, hosted in the Cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub.

IoT Hub supports communications both from the device to the cloud and from the cloud to the device. IoT Hub supports multiple messaging patterns such as device-to-cloud telemetry, file upload from devices, and request-reply methods to control your devices from the cloud. IoT Hub monitoring helps you maintain the health of your solution by tracking events such as device creation, device failures, and device connections.

IoT Hub's capabilities help you build scalable, full-featured IoT solutions such as managing industrial equipment used in manufacturing, tracking valuable assets in healthcare, and monitoring office building usage.

## Procedure

### **Enroll Device into DPS (Device Provisioning Service)**
1. Generate certificates by running the Microchip IoT Provision tool
        
    `.\iotprovision-bin.exe -c azure`
        
    Output example:

    ```
    WARNING - Account setup for 'azure' not yet implemented

    Upgrade debugger firmware if required...
    Debugger firmware already up to date (1.22.73)

    Upgrade WINC firmware if required...
    Firmware 'iotprovision' version: 0.4.0
    Querying current WINC firmware version
    WINC firmware version: 19.6.5
    WINC driver version: 19.3.0
    WINC firmware is already up to date.
    Skipping upgrade.

    Generate certificates if required...
    Creating root of trust...

    Provisioning PIC-IoT WG for azure ...
    Firmware 'iotprovision-azure' version: 0.4.0
    Loading root CA certificate``
        Loading from C:\Users\username\.microchip-iot\root-ca.crt       
    Loading signer CA certificate
        Loading from C:\Users\username\.microchip-iot\signer-ca.crt
    Erase WINC TLS certificate sector
    WINC erase TLS certificate sectors
    WINC Erase sector at address 0x005000
    WINC Erase sector at address 0x006000
    Generating device certificate
    Provisioning device with credentials
    Send Device Certificate
    Send Signer Certificate
    Transfer certificates to WINC
    WINC write 1470 bytes to address 0x5000
    Replacing click-me link for 'azure'
    Done provisioning device 'sn012377D2FE4C840CFE'

    Programming application: Bundled Demo for azure...
    Firmware 'demo-azure' version: v1.1.1


    Rebooting debugger...

    Done.
    ```

1. Set up certificates for the verification process:

    - Go to generated cert location in the previous step at `\[your_path]\.microchip-iot`

    - Copy all `*.crt` files and rename them each to `*.pem`

1. In the [Microsoft Azure Portal](https://portal.azure.com/#home), upload the root CA cert `root-ca.pem` in DPS and do proof-of-possession for X.509 CA certificates with your Device Provisioning Service

- Register the public part of an X.509 certificate and get a verification code

    Follow the `Register the public part of an X.509 certificate and get a verification code` section in [How to Verify Certificates](https://docs.microsoft.com/azure/iot-dps/how-to-verify-certificates)

    The verification code is generated by encrypting the public key portion of your X.509 certification. It will be used to validate the uploaded certificate ownership. So make sure to copy the generated verification code to clipboard for use in an upcoming step.

- Digitally sign the verification code to create a verification certificate

    Now that you've registered your root CA with Azure IoT Hub, you'll need to prove that you actually own it by:

> 1. Generating the Certificate Signing Request (CSR) using the verification code
> 2. Generating a verification certificate using CSR above

### **Demonstrate Proof of Possession**

Upload your verification certificate to DPS for [Proof of Possession](https://tools.ietf.org/html/rfc5280#section-3.1) with the following steps:

1. Open a Git Bash window (Start menu &gt; type “Git Bash”)

    <img src=".//media/image15.png"/>

2. Change the directory to your certificates folder (which was generated by the IoT Provisioning Tool):

    ```bash
    cd drive:\<your_path>\.microchip-iot

    Example: cd C:\Users\john5\Azure\.microchip-iot
    ```

3. Generate a certification signing request (CSR) by entering the below command. A CSR is generated by encrypting these two key inputs:

    - The `root-ca.key` generated in previous step by Microchip IoT Provisioning tool. This will be used in the openssl command line below.
    - The `Verification Code` generated from DPS in previous step. You will be asked to provide this during the process of creating the CSR.

    **Note**: Once you enter to command below, you will then be asked to enter information that will be used to will be incorporated into your certificate request. Enter verification code (generated from Azure portal) when prompt for CommonName. For the rest, you can enter anything you want.

    ```bash
    openssl req -new -key root-ca.key -out azure_root_ca_verification.csr
    ```

    As a result, you should see the file `azure_root_ca_verification.csr` appear in the \\.microchip-iot folder: 

    <img src=".//media/image16.png"/>

4. Generate a verification certificate by executing the following command:

    ```bash
    openssl x509 -req -in azure_root_ca_verification.csr -CA root-ca.crt -CAkey root-ca.key -CAcreateserial -out azure_signer_verification.cer -days 365 -sha256
    ```

    As a result, you should see the file `azure_signer_verification.cer` appear in the \\.microchip-iot folder:

    <img src=".//media/image17.png"/>

### **Upload the Signed Verification Certificate to DPS**

Follow the `Upload the signed verification certificate` section in
[How to Verify Certificates](https://docs.microsoft.com/azure/iot-dps/how-to-verify-certificates).  As a result, the status of your uploaded certification should be “Verified” as shown below (make sure to refresh the page to see the updated change in status). 

<img src=".//media/image18.png"/>

### **Add a New Enrollment Group using the Signer Certificate**

1. In the Azure portal, navigate to your DPS &gt; `Manage enrollments` &gt;
Select `Enrollment Groups` tab:

    <img src=".//media/image19.png"/>

2. Add enrollment group &gt; Enter `Group name` &gt; Choose Certificate as `Attestation Type` &gt; Choose `False` for IoT Edge Device &gt; Choose `Intermediate Certificate` as Certificate Type &gt; Upload
`\[path]\.microchip-iot\signer-ca.pem` to Primary Certificate &gt; select `Evenly weighted distribution` for how you want to assign devices to hub &gt; select your IoT Hub that this new enrollment group can assign to &gt; leave the rest as their existing defaults &gt; hit `Save`

    <img src=".//media/image20.png"/>
    
    Once this has been done, your enrollment group name should show up in the Enrollment Groups tab

### **Program the Plug and Play Demo**

[IoT Plug and Play](https://docs.microsoft.com/en-us/azure/iot-develop/overview-iot-plug-and-play) enables solution builders to integrate IoT devices with their solutions without any manual configuration. At the core of IoT Plug and Play is a device model that a device uses to advertise its capabilities to an IoT Plug and Play-enabled application. This model is structured as a set of elements that define:

- `Properties` that represent the read-only or writable state of a device or other entity. For example, a device serial number may be a read-only property and a target temperature on a thermostat may be a writable property

- `Telemetry` that's the data emitted by a device, whether the data is a regular stream of sensor readings, an occasional error, or an information message

- `Commands` that describe a function or operation that can be done on a device. For example, a command could reboot a gateway or take a picture using a remote camera

1. Clone/download the MPLAB X demo project
    by issuing the following commands in a `Command Prompt` or `PowerShell`
    window:

    ```bash
    git clone https://github.com/Azure-Samples/Microchip-PIC-IoT-Wx.git
    cd Microchip-PIC-IoT-Wx
    git submodule update --init
    ```

2. Connect the board to PC, then make sure `CURIOSITY` device shows up as a disk drive on the `Desktop` or in a `File Explorer` window. Drag and drop (i.e. copy) the pre-built `*.hex` file (located in the folder at `Microchip-PIC-IoT-Wx` > `AzurePnPDps.X` > `dist` > `default` > `production`) to the `CURIOSITY` drive 

    <img src=".//media/image115.png">

    NOTE: If this file copy operation fails for any reason, [Make and Program Device](./AzurePnP_MPLABX.md) by building the MPLAB X source code project that was used to generate the `*.hex` file

3. Set up a Command Line Interface (CLI) to the board

    - Open a serial terminal window (e.g. PuTTY, TeraTerm, etc.) and connect to the COM port corresponding to your board at `9600 baud` (e.g. open PuTTY Configuration window &gt; choose `session` &gt; choose `Serial`&gt; Enter the right COMx port). You can find the COM info by opening your PC’s `Device Manager` &gt; expand `Ports(COM & LPT)` &gt; take note of the `Curiosity Virtual COM Port`

    - In your `Terminal Options`, enable `Local Echo` to allow your keystrokes to be displayed in the terminal window

        <img src=".//media/image27.png">

4. In the terminal emulator window, hit `[RETURN]` to get the list of available commands for the CLI.  The Command Line Interface allows you to send simple ASCII-string commands to set or get the user-configurable operating parameters of the application while it is running.  The CLI prompt is simply the `.` (period) character

    <img src=".//media/image44.png">

5. In the terminal emulator window, set the debug messaging level to 0 to temporarily disable the output messages. The debug level can be set anywhere from 0 to 4.  Use the `debug <level>` command by manually typing it into the CLI.  The complete command must be followed by hitting `[RETURN]`
    ```bash
    >debug 0
    ```

6. Set the Wi-Fi credentials used by your board whenever it tries to connect to an Access Point (which must be operating in the 2.4 GHz band). If an iPhone is being used as a hotspot, the `Maximize Compatibility` option must be enabled. Execute the following `wifi` command on the CLI

    ```bash
    wifi <NETWORK_SSID>,<PASSWORD>,<SECURITY_OPTION[1=Open|2=WPA|3=WEP]>
    ```
    For example, if the SSID of the router is "MyWirelessRouter" and the WPA/WPA2 key is "MyRoutersPassword", the exact command to type into the CLI (followed by `[RETURN]`) would be
    ```bash
    wifi MyWirelessRouter,MyRoutersPassword,2
    ```

    Once these credentials have been used to successfully connect to Wi-Fi once, they will be stored in the board and will be used in all subsequent Wi-Fi connection attempts.  In other words, the `wifi` command only needs to be executed successfully one time for your 2.4 GHz Access Point.  As an alternative, the Wi-Fi credentials can also be configured by using the [Wi-Fi Configuration online tool](https://iot.microchip.com/wificfg).

7. Look up the ID Scope corresponding to your DPS in the Microsoft Azure Portal.  This value is displayed in a web browser when clicking on `Overview` on the DPS resource page (the DPS was created earlier using a web page on the Azure Portal).  The ID Scope is programmed/saved into the PIC-IoT board in the next step using a CLI command (allowing you to change the ID Scope for the board without having to reprogram the MCU's application firmware)

    <img src=".//media/image23.png"/>

8. In the terminal emulator window, confirm that `local echo` is enabled in the terminal settings.  At the CLI prompt, type in the command `idscope <MY_ID_SCOPE>` to set the ID Scope (which gets saved in the ATECC608B secure element on the PIC-IoT board) and then hit `[RETURN]`.  To confirm it was set correctly, the ID Scope can be read out from the board by issuing the `idscope` command (i.e. without specifying an ID Scope value as the parameter on the command line)

    <img src=".//media/image46.png"/>

9. At the CLI prompt, type in the command `reset` and hit `[ENTER]` to restart the application using the updated ID Scope to establish a connection to your DPS.

10.	Wait for the PIC-IoT board to connect to your DPS and stabilize (allow up to 2 minutes); eventually the Blue and Green LEDs should both stay constantly on (which signifies a successful & stable DPS connection).  If the Red LED comes on and stays lit, then something was incorrectly programmed (e.g. application firmware, Wi-Fi credentials, ID Scope).  If the Blue LED is not constantly on, then there is an issue with connecting to your wireless access point.

11. To enable the “full” debug messaging output to the terminal emulator window, execute the command `debug 4` on the CLI.  To disable the debug messages at any time, execute the command `debug 0` (debug levels range from 0 to 4).  The CLI is always active, even while debug messages are being continuously displayed on the terminal window.

12. Experiment with the CLI commands to control the LED’s from the terminal emulator window by issuing the `led` command (usage: "led [led],[state]")
[led] : {1 = blue, 2 = green, 3 = yellow, 4 = red}
[state] : {1 = on, 2 = off, 3 = start blinking, 4 = stop blinking}

    <img src=".//media/image75.png" style="width:8.in;height:6.18982in" alt="A screenshot of a cell phone Description automatically generated" />	

### **Verify the PIC-IoT Device Registration to Azure IoT Hub**

A successful PIC-IoT to Azure DPS connection can be verified two ways:

1) Correct device ID shows up in the DPS enrollment
2) Correct device ID shows up in the IoT Hub

Procedure:

1. In the [Azure Portal](https://portal.azure.com/#home), go to your DPS &gt; click `Manage enrollments` &gt; under Enrollment Group, click `your group name` &gt; click `Registration Records` &gt; device should show up with the IoT Hub info that it got assigned to

    <img src=".//media/image28.png"/>

2. In the [Azure Portal](https://portal.azure.com/#home), go to your IoT Hub &gt; click `IoT
    Devices` &gt; click `Refresh` &gt; device should show up with the
    Status “Enabled” and Authentication Type of “SelfSigned”

    <img src=".//media/image29.png"/>

### **PIC-IoT Board Interaction with Azure IoT Explorer**

 Once the PIC-IoT connection to Azure IoT Hub has been verified, the device can be monitored & controlled using Microsoft's Azure IoT Explorer. The Azure IoT Explorer is a graphical tool for interacting with and testing your IoT device on Azure. Refer to [Install Azure IoT Explorer](https://docs.microsoft.com/azure/iot-pnp/howto-install-iot-explorer#install-azure-iot-explorer) for additional details.

1. Connect Azure IoT Explorer to IoT Hub by providing your IoT Hub’s connection string.  From the Azure Portal: click on `your IoT Hub` &gt; `Shared access polices` &gt; `iothubowner` &gt; connection string-primary key &gt; Copy to clipboard

    <img src=".//media/image30.png" style="width:2in;height:4in" alt="A screenshot of a cell phone Description automatically generated" />

2. Launch Azure IoT Explorer: Click on “Add connection” &gt; paste the
    Connection String &gt; Save

    <img src=".//media/image31.png" style="width:5.56482in;height:2.24436in" alt="A screenshot of a cell phone Description automatically generated" />

    <img src=".//media/image37.png" style="width:4.49781in;height:3.72222in" alt="A screenshot of a cell phone Description automatically generated" />

3. In the Azure IoT Explorer window, click on the `Home` link near the top of the window

4. On the left-hand side of the Azure IoT Explorer window, click on `IoT Plug and Play Settings`

    <img src=".//media/image48.png"/>

5. Please make sure `Public repository` is in the list

    If `Public repository` is not listed, add it using the `Add` icon

    <img src=".//media/image49.png" />

6. Click on `Save`

    <img src=".//media/image50.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

7. On the left-hand side of the IoT Explorer window, click on `IoT hubs`

    <img src=".//media/image51.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

8. Verify that the name of your IoT hub is displayed, then click on `View devices in this hub`

    <img src=".//media/image52.png" />

9. Verify that your device ID is displayed (and status is enabled), then click on it

    <img src=".//media/image53.png" />
  
10. On the left-hand side of the IoT Explorer window, click on `IoT Plug and Play components`

    <img src=".//media/image54.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />	

11.	Click on `Default component` near the bottom of the IoT Explorer window

    <img src=".//media/image55.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />
 
12.	Click on `Properties (read-only)` near the top of the IoT Explorer window

13.	Confirm that the `Enum` value of each LED matches the state observed on the PIC-IoT board (1 = On, 2 = Off, 3 = Blinking) and note the maximum temperature reading since device reset (maxTempSinceLastReboot)

    <img src=".//media/image57.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

14.	Click on `Properties (writable)` near the top of the IoT Explorer window

15. Click on the input field labeled `led_yellow` and select `Blink`

    <img src=".//media/image59.png" />

16. Click on `Update desired value`

    <img src=".//media/image60.png" style="width:5.in;height:1.48982in" alt="A screenshot of a cell phone Description automatically generated" />

17. Observe the notification that the request to write the property was accepted by your device, and that the Yellow LED on the PIC-IoT board is blinking/toggling/flashing

    <img src=".//media/image61.png" style="width:5.in;height:1.48982in" alt="A screenshot of a cell phone Description automatically generated" />

18. Click on `Commands` near the top of the IoT Explorer window

19. To set up the getMaxMinReport command, hover the mouse near the right corners of the since input field until the little triangle shows up and then click on it

20. When the calendar window pops up, select today’s date

    <img src=".//media/image64.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

21. Type in the current time

    <img src=".//media/image65.png" style="width:4.in;height:1.18982in" alt="A screenshot of a cell phone Description automatically generated" />

22. Click on `Send command`

    <img src=".//media/image66.png" style="width:4.in;height:1.78982in" alt="A screenshot of a cell phone Description automatically generated" />

23. Confirm that the command was successfully invoked and that both the max & min temperatures are reported in the message that appears in the pop-up window (once the message window disappears, it can be read again by clicking on `Notifications`)

    <img src=".//media/image67.png" style="width:5.in;height:3.18982in" alt="A screenshot of a cell phone Description automatically generated" />

24. Click on `Telemetry` near the top of the IoT Explorer window and then click on `Start`

25. Observe the telemetry data (for the temperature and light sensors) is updating every few seconds

    <img src=".//media/image69.png" style="width:5.in;height:2.18982in" alt="A screenshot of a cell phone Description automatically generated" />

26. Increase the ambient light shining on top of the board and observe that the value of the light sensor increases within a few seconds

    <img src=".//media/image70.png" />

27. On the PIC-IoT Wx development board, press and release user buttons SW0 and/or SW1 

    <img src=".//media/image71.png" style="width:5.in;height:1.18982in" alt="A screenshot of a cell phone Description automatically generated" />

28. Observe the button event message (telemetry) that is generated each time a user button has been pressed/released

    <img src=".//media/image72.png" />

29. Click on `Commands` near the top of the IoT Explorer window

30. Click on the input field for `delay` and type `PT10S`, then click `Send command`.  Confirm that the command was successfully invoked via a notification message, and then the board resets itself in approximately 10 seconds (the LEDs on the board will cycle and re-initialize)

    <img src=".//media/image74.png" />
